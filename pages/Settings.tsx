
import React, { useState, useEffect } from 'react';
import { useAuth } from '../context/AuthContext';
import { useTheme } from '../context/ThemeContext';
import { 
  getSupabaseConfig, setSupabaseConfig, testApiConnection, 
  getDataSource, setDataSource
} from '../services/db';
import { DataSourceType } from '../types';
import { 
  LogOut, Moon, Sun, Check, AlertCircle, 
  CheckCircle, RefreshCw, Globe, ShieldAlert, Play, Server, 
  Database, Copy, Info, Terminal, HardDrive,
  ExternalLink, Lock, Unlock, Database as DbIcon, ShieldCheck,
  Monitor, Settings as SettingsIcon, AlertOctagon, MousePointer2, ChevronRight, Zap,
  AlertTriangle, DatabaseZap
} from 'lucide-react';

const SUPABASE_SQL_SCRIPT = `-- üöÄ Supabase Setup Script for QC Master
-- ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà "SQL Editor" -> "New Query" ‡πÉ‡∏ô Supabase Dashboard ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Run

-- 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á Products (‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)
CREATE TABLE IF NOT EXISTS products (
    barcode TEXT PRIMARY KEY,
    product_name TEXT NOT NULL,
    cost_price NUMERIC DEFAULT 0,
    unit_price NUMERIC DEFAULT 0,
    lot_no TEXT,
    product_type TEXT,
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á QC Logs (‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à)
CREATE TABLE IF NOT EXISTS qc_logs (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    barcode TEXT,
    product_name TEXT,
    cost_price NUMERIC,
    selling_price NUMERIC,
    status TEXT,
    reason TEXT,
    remark TEXT,
    inspector_id TEXT,
    image_urls JSONB DEFAULT '[]'::jsonb,
    timestamp TIMESTAMPTZ DEFAULT NOW()
);

-- 3. ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Row Level Security (RLS)
ALTER TABLE products ENABLE ROW LEVEL SECURITY;
ALTER TABLE qc_logs ENABLE ROW LEVEL SECURITY;

-- 4. ‡∏™‡∏£‡πâ‡∏≤‡∏á Policy ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Anon Key (Public) ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ ‡∏≠‡πà‡∏≤‡∏ô/‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ
-- (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ Anon Key ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)
DROP POLICY IF EXISTS "Public Access Products" ON products;
CREATE POLICY "Public Access Products" ON products FOR ALL TO anon USING (true) WITH CHECK (true);

DROP POLICY IF EXISTS "Public Access QC Logs" ON qc_logs;
CREATE POLICY "Public Access QC Logs" ON qc_logs FOR ALL TO anon USING (true) WITH CHECK (true);`;

export const Settings: React.FC = () => {
  const { logout } = useAuth();
  const { isDark, toggleTheme } = useTheme();
  const [dataSource, setDataSourceState] = useState<DataSourceType>(getDataSource());
  const initialConfig = getSupabaseConfig();
  const [url, setUrl] = useState(initialConfig.url);
  const [key, setKey] = useState(initialConfig.key);
  
  const [testStatus, setTestStatus] = useState<{status: 'idle' | 'loading' | 'success' | 'error', message: string, code?: string}>({status: 'idle', message: ''});
  const [activeTab, setActiveTab] = useState<'config' | 'sql' | 'mixed'>('config');

  const handleToggleSource = (type: DataSourceType) => {
    setDataSource(type);
    setDataSourceState(type);
    setTestStatus({status: 'idle', message: ''});
  };

  const handleSaveConfig = () => {
    setSupabaseConfig(url, key);
    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Supabase ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  };

  const handleTestConnection = async () => {
    setTestStatus({status: 'loading', message: 'Connecting to Supabase...'});
    const result = await testApiConnection(url, key);
    if (result.success) {
      setTestStatus({status: 'success', message: result.message || 'Connected!'});
    } else {
      let msg = result.error || 'Connection Failed';
      let code = '';
      
      if (result.error === "CONNECTED_BUT_TABLES_MISSING") {
          msg = "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
          code = 'TABLES_MISSING';
      }
      
      setTestStatus({
          status: 'error', 
          message: msg,
          code: code
      });
    }
  };

  const copy = (text: string, msg: string) => {
    navigator.clipboard.writeText(text);
    alert(msg);
  };

  return (
    <div className="space-y-6 pb-24 animate-fade-in max-w-5xl mx-auto">
      <div className="flex justify-between items-center px-2">
        <h1 className="text-3xl font-display font-bold text-gray-800 dark:text-white flex items-center gap-3">
            <SettingsIcon className="text-pastel-blueDark" />
            ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö
        </h1>
        <button onClick={logout} className="p-3 bg-red-50 text-red-500 rounded-2xl hover:bg-red-100 transition-colors">
            <LogOut size={20} />
        </button>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <div className="lg:col-span-1 space-y-4">
            <div className="bg-white dark:bg-gray-800 p-6 rounded-[2rem] shadow-sm border border-gray-100 dark:border-gray-700">
                <h3 className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                <div className="space-y-2">
                    <button onClick={() => handleToggleSource(DataSourceType.SUPABASE)} className={`w-full p-4 rounded-2xl flex items-center gap-3 transition-all ${dataSource === DataSourceType.SUPABASE ? 'bg-pastel-blueDark text-white shadow-lg' : 'bg-gray-50 text-gray-500'}`}>
                        <Zap size={18} /> <span className="text-sm font-bold">Supabase (Cloud)</span>
                    </button>
                    <button onClick={() => handleToggleSource(DataSourceType.GOOGLE_SHEETS)} className={`w-full p-4 rounded-2xl flex items-center gap-3 transition-all ${dataSource === DataSourceType.GOOGLE_SHEETS ? 'bg-pastel-blueDark text-white shadow-lg' : 'bg-gray-50 text-gray-500'}`}>
                        <Globe size={18} /> <span className="text-sm font-bold">Google Sheets</span>
                    </button>
                </div>
            </div>
            <button onClick={toggleTheme} className="w-full p-6 bg-white dark:bg-gray-800 rounded-[2rem] flex items-center justify-between shadow-sm border border-gray-100 dark:border-gray-700">
                <span className="text-sm font-bold dark:text-white">‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô</span>
                {isDark ? <Moon className="text-purple-400" /> : <Sun className="text-orange-400" />}
            </button>
        </div>

        <div className="lg:col-span-3 space-y-4">
            <div className="bg-white dark:bg-gray-800 rounded-[2.5rem] shadow-xl border border-gray-100 dark:border-gray-700 overflow-hidden">
                <div className="flex bg-gray-50 dark:bg-gray-900/50 p-2 m-4 rounded-2xl gap-2 overflow-x-auto no-scrollbar">
                    <button onClick={() => setActiveTab('config')} className={`px-6 py-3 rounded-xl text-xs font-bold transition-all whitespace-nowrap ${activeTab === 'config' ? 'bg-white dark:bg-gray-800 shadow-sm text-pastel-blueDark dark:text-white' : 'text-gray-400'}`}>1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Supabase</button>
                    <button onClick={() => setActiveTab('sql')} className={`px-6 py-3 rounded-xl text-xs font-bold transition-all whitespace-nowrap ${activeTab === 'sql' || testStatus.code === 'TABLES_MISSING' ? 'bg-amber-100 text-amber-700 shadow-sm' : 'text-gray-400'}`}>2. SQL Editor {testStatus.code === 'TABLES_MISSING' && "‚ö†Ô∏è"}</button>
                    <button onClick={() => setActiveTab('mixed')} className={`px-6 py-3 rounded-xl text-xs font-bold transition-all whitespace-nowrap ${activeTab === 'mixed' ? 'bg-white dark:bg-gray-800 shadow-sm text-pastel-blueDark dark:text-white' : 'text-gray-400'}`}>3. ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</button>
                </div>

                <div className="p-8 pt-4">
                    {activeTab === 'config' && (
                        <div className="space-y-6 animate-fade-in">
                            <div className="space-y-4">
                                <div className="space-y-2">
                                    <label className="text-xs font-bold text-gray-500 uppercase ml-1">Project URL</label>
                                    <input type="text" value={url} onChange={(e) => setUrl(e.target.value)} className="w-full p-4 bg-gray-50 dark:bg-gray-900 rounded-2xl font-mono text-xs outline-none border-2 border-transparent focus:border-pastel-blueDark" placeholder="https://your-project.supabase.co" />
                                </div>
                                <div className="space-y-2">
                                    <label className="text-xs font-bold text-gray-500 uppercase ml-1">Anon / Public Key</label>
                                    <textarea value={key} onChange={(e) => setKey(e.target.value)} className="w-full p-4 bg-gray-50 dark:bg-gray-900 rounded-2xl font-mono text-[10px] outline-none border-2 border-transparent focus:border-pastel-blueDark h-24 resize-none" placeholder="eyJhbGciOiJIUzI1Ni..." />
                                </div>
                                <div className="flex gap-3">
                                    <button onClick={handleSaveConfig} className="flex-1 bg-pastel-blueDark text-white py-4 rounded-2xl font-bold transition-all active:scale-95 shadow-lg shadow-blue-500/20">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                                    <button onClick={handleTestConnection} disabled={testStatus.status === 'loading'} className="flex-1 bg-gray-800 text-white py-4 rounded-2xl font-bold flex items-center justify-center gap-2 hover:bg-black transition-all">
                                        {testStatus.status === 'loading' ? <RefreshCw className="animate-spin" /> : <Play size={18} />} ‡∏ó‡∏î‡∏™‡∏≠‡∏ö
                                    </button>
                                </div>
                            </div>
                            
                            {testStatus.status !== 'idle' && (
                                <div className={`p-5 rounded-3xl flex flex-col gap-3 animate-slide-up ${testStatus.status === 'success' ? 'bg-green-50 text-green-700 border border-green-200' : 'bg-red-50 text-red-700 border border-red-200'}`}>
                                    <div className="flex items-center gap-3">
                                        {testStatus.status === 'success' ? <CheckCircle size={20} /> : <AlertCircle size={20} />}
                                        <span className="text-sm font-bold">{testStatus.message}</span>
                                    </div>
                                    {testStatus.code === 'TABLES_MISSING' && (
                                        <button 
                                            onClick={() => setActiveTab('sql')}
                                            className="bg-white/50 p-3 rounded-xl text-xs font-bold flex items-center justify-center gap-2 hover:bg-white transition-all border border-red-200"
                                        >
                                            <DatabaseZap size={16} /> ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏î‡∏π‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                                        </button>
                                    )}
                                </div>
                            )}
                        </div>
                    )}

                    {activeTab === 'sql' && (
                        <div className="space-y-4 animate-fade-in">
                            <div className="flex items-center gap-3 p-4 bg-amber-50 text-amber-800 rounded-2xl text-xs border border-amber-100">
                                <Zap size={16} /> <span>‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà <b>SQL Editor</b> ‡πÉ‡∏ô Supabase Dashboard ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î <b>Run</b></span>
                            </div>
                            <div className="relative">
                                <pre className="bg-gray-900 text-blue-400 p-6 rounded-2xl text-[10px] font-mono overflow-auto max-h-80 no-scrollbar leading-relaxed">{SUPABASE_SQL_SCRIPT}</pre>
                                <button onClick={() => copy(SUPABASE_SQL_SCRIPT, 'SQL Copied!')} className="absolute top-4 right-4 p-3 bg-white/10 rounded-xl text-white hover:bg-white/20 active:scale-90 transition-all"><Copy size={18}/></button>
                            </div>
                            <p className="text-[10px] text-gray-400 italic px-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á products, qc_logs ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ‡πÅ‡∏ö‡∏ö Public</p>
                        </div>
                    )}

                    {activeTab === 'mixed' && (
                        <div className="space-y-6 animate-fade-in text-sm">
                            <div className="p-6 bg-blue-50 dark:bg-blue-900/10 border-2 border-blue-200 dark:border-blue-900/30 rounded-3xl space-y-3">
                                <div className="flex items-center gap-2 text-blue-700 dark:text-blue-400">
                                    <Info />
                                    <h4 className="font-bold text-lg">‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ Supabase ‡∏î‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?</h4>
                                </div>
                                <ul className="list-disc ml-5 text-blue-800/70 dark:text-blue-300/60 leading-relaxed space-y-1">
                                    <li>‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ô XAMPP</li>
                                    <li>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô</li>
                                    <li>‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏™‡∏π‡∏á‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢</li>
                                    <li>‡∏ü‡∏£‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å</li>
                                </ul>
                            </div>
                        </div>
                    )}
                </div>
            </div>
        </div>
      </div>
    </div>
  );
};
